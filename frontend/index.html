<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeChain - Agricultural Settlement Platform</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-icon">üåæ</span>
                <span class="logo-text">TradeChain</span>
            </div>
            <div class="nav-links">
                <a href="#" class="nav-link active">Dashboard</a>
                <a href="#" class="nav-link">Marketplace</a>
                <a href="#" class="nav-link">Analytics</a>
            </div>
            <div class="nav-actions">
                <button class="btn-outline">Connect Wallet</button>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h1 class="hero-title">Agricultural Settlement Platform</h1>
            <p class="hero-subtitle">Tokenize crops, execute instant settlements, and maintain full regulatory compliance</p>
            <div class="hero-stats">
                <div class="stat-item">
                    <div class="stat-value" id="heroTotalCrops">0</div>
                    <div class="stat-label">Total Crops</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="heroTotalVolume">‚Çπ0</div>
                    <div class="stat-label">Total Volume</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="heroSettlements">0</div>
                    <div class="stat-label">Settlements</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">0.5s</div>
                    <div class="stat-label">Avg Settlement Time</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="register">
                <span class="tab-icon">üìù</span>
                <span>Register Crop</span>
            </button>
            <button class="tab-btn" data-tab="marketplace">
                <span class="tab-icon">üè™</span>
                <span>Marketplace</span>
            </button>
            <button class="tab-btn" data-tab="settle">
                <span class="tab-icon">‚ö°</span>
                <span>Settlements</span>
            </button>
            <button class="tab-btn" data-tab="audit">
                <span class="tab-icon">üîê</span>
                <span>Audit Trail</span>
            </button>
        </div>

        <!-- Register Crop Tab -->
        <div class="tab-content active" id="registerTab">
            <div class="content-grid">
                <div class="main-panel">
                    <div class="card">
                        <div class="card-header">
                            <h2>Register New Crop</h2>
                            <p>Tokenize your agricultural assets on the blockchain</p>
                        </div>
                        <form id="cropForm" class="form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Crop Type</label>
                                    <select id="cropType" required>
                                        <option value="">Select crop type</option>
                                        <option value="wheat">üåæ Wheat</option>
                                        <option value="rice">üçö Rice</option>
                                        <option value="cotton">‚òÅÔ∏è Cotton</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Quality Grade</label>
                                    <select id="qualityGrade" required>
                                        <option value="">Select grade</option>
                                        <option value="A">Grade A - Premium</option>
                                        <option value="B">Grade B - Standard</option>
                                        <option value="C">Grade C - Basic</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Quantity (kg)</label>
                                    <input type="number" id="quantity" required min="1" step="0.01" placeholder="Enter quantity">
                                </div>
                                <div class="form-group">
                                    <label>Mandi Location</label>
                                    <select id="mandiId" required>
                                        <option value="">Select mandi</option>
                                        <option value="PUNE-MKT-01">üìç Pune Market 01</option>
                                        <option value="MUMBAI-MKT-02">üìç Mumbai Market 02</option>
                                        <option value="NASHIK-MKT-03">üìç Nashik Market 03</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Farmer ID</label>
                                <input type="text" id="farmerId" required placeholder="e.g., FARMER_001">
                            </div>

                            <button type="submit" class="btn-primary btn-large">
                                <span>Register & Tokenize Crop</span>
                                <span class="btn-arrow">‚Üí</span>
                            </button>
                        </form>

                        <div id="registerResult" class="result-message"></div>
                    </div>
                </div>

                <div class="side-panel">
                    <div class="info-card">
                        <h3>How It Works</h3>
                        <div class="steps">
                            <div class="step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h4>Register Crop</h4>
                                    <p>Submit your crop details and quality certification</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h4>Auto Tokenization</h4>
                                    <p>System creates a unique digital token for your crop</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h4>List & Trade</h4>
                                    <p>List your token on marketplace and execute instant settlements</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Marketplace Tab -->
        <div class="tab-content" id="marketplaceTab">
            <div class="card">
                <div class="card-header">
                    <h2>Token Marketplace</h2>
                    <div class="filter-controls">
                        <select id="statusFilter" class="filter-select">
                            <option value="">All Statuses</option>
                            <option value="CREATED">Created</option>
                            <option value="LISTED">Listed</option>
                            <option value="SETTLED">Settled</option>
                        </select>
                    </div>
                </div>
                <div id="tokensList" class="marketplace-grid"></div>
            </div>
        </div>

        <!-- Settlements Tab -->
        <div class="tab-content" id="settleTab">
            <div class="content-grid">
                <div class="main-panel">
                    <div class="card">
                        <div class="card-header">
                            <h2>Execute Settlement</h2>
                            <p>Instant blockchain-based settlement in 0.5 seconds</p>
                        </div>
                        <form id="settlementForm" class="form">
                            <div class="form-group">
                                <label>Token ID</label>
                                <input type="text" id="settleTokenId" required placeholder="TOKEN_...">
                            </div>
                            <div class="form-group">
                                <label>Buyer ID</label>
                                <input type="text" id="buyerId" required placeholder="e.g., TRADER_001">
                            </div>
                            <button type="submit" class="btn-primary btn-large">
                                <span>Execute Settlement</span>
                                <span class="btn-arrow">‚ö°</span>
                            </button>
                        </form>
                        <div id="settlementResult" class="result-message"></div>
                    </div>

                    <div class="card" style="margin-top: 24px;">
                        <div class="card-header">
                            <h2>Settlement History</h2>
                        </div>
                        <div id="settlementsList"></div>
                    </div>
                </div>

                <div class="side-panel">
                    <div class="info-card">
                        <h3>Settlement Benefits</h3>
                        <ul class="benefit-list">
                            <li>‚ö° Instant settlement (0.5s)</li>
                            <li>üîí Tamper-proof records</li>
                            <li>üí∞ Fair oracle pricing</li>
                            <li>üìä Full transparency</li>
                            <li>‚úÖ Regulatory compliant</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audit Trail Tab -->
        <div class="tab-content" id="auditTab">
            <div class="card">
                <div class="card-header">
                    <h2>Blockchain Audit Trail</h2>
                    <button class="btn-outline" onclick="verifyAuditIntegrity()">
                        <span>üîç Verify Integrity</span>
                    </button>
                </div>
                <div id="verificationResult" class="verification-result"></div>
                <div id="auditTrail" class="audit-container"></div>
            </div>
        </div>
    </div>

    <!-- Compliance Footer -->
    <footer class="compliance-footer">
        <div class="compliance-content">
            <h3>‚öñÔ∏è Regulatory Compliance</h3>
            <div class="compliance-grid">
                <div class="compliance-item">‚úì No real financial transactions</div>
                <div class="compliance-item">‚úì Simulated settlements only</div>
                <div class="compliance-item">‚úì KYC/AML awareness</div>
                <div class="compliance-item">‚úì Full audit trail</div>
                <div class="compliance-item">‚úì Non-speculative tokens</div>
                <div class="compliance-item">‚úì Regulator-readable logs</div>
            </div>
        </div>
    </footer>

    <script>
        const API_BASE = 'http://localhost:8000/api';

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(tab + 'Tab').classList.add('active');

                if (tab === 'marketplace') loadTokens();
                if (tab === 'settle') loadSettlements();
                if (tab === 'audit') loadAuditTrail();
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadTokens();
            loadSettlements();
            loadAuditTrail();
        });

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('heroTotalCrops').textContent = data.stats.total_crops;
                    document.getElementById('heroTotalVolume').textContent = '‚Çπ' + data.stats.total_settlement_volume.toFixed(0);
                    document.getElementById('heroSettlements').textContent = data.stats.total_settlements;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Register crop
        document.getElementById('cropForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                crop_type: document.getElementById('cropType').value,
                quantity: parseFloat(document.getElementById('quantity').value),
                quality_grade: document.getElementById('qualityGrade').value,
                mandi_id: document.getElementById('mandiId').value,
                farmer_id: document.getElementById('farmerId').value
            };

            try {
                const response = await fetch(`${API_BASE}/crops/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                const resultDiv = document.getElementById('registerResult');
                
                if (data.success) {
                    resultDiv.className = 'result-message success';
                    resultDiv.innerHTML = `
                        <div class="success-icon">‚úì</div>
                        <h3>Crop Successfully Tokenized!</h3>
                        <div class="result-details">
                            <p><strong>Crop ID:</strong> ${data.crop.crop_id}</p>
                            <p><strong>Token ID:</strong> ${data.token.token_id}</p>
                            <p><strong>Status:</strong> <span class="badge badge-created">${data.token.status}</span></p>
                        </div>
                    `;
                    document.getElementById('cropForm').reset();
                    loadStats();
                    loadTokens();
                } else {
                    resultDiv.className = 'result-message error';
                    resultDiv.innerHTML = `<div class="error-icon">‚úó</div><p>${data.message}</p>`;
                }
            } catch (error) {
                document.getElementById('registerResult').className = 'result-message error';
                document.getElementById('registerResult').innerHTML = `<div class="error-icon">‚úó</div><p>Error: ${error.message}</p>`;
            }
        });

        // Load tokens
        async function loadTokens() {
            const status = document.getElementById('statusFilter')?.value || '';
            const url = status ? `${API_BASE}/tokens/status/${status}` : `${API_BASE}/tokens`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                const tokensList = document.getElementById('tokensList');
                if (data.tokens.length === 0) {
                    tokensList.innerHTML = '<div class="empty-state"><p>No tokens found</p></div>';
                    return;
                }

                tokensList.innerHTML = data.tokens.map(token => `
                    <div class="token-card">
                        <div class="token-header">
                            <span class="token-id">${token.token_id.substring(0, 20)}...</span>
                            <span class="badge badge-${token.status.toLowerCase()}">${token.status}</span>
                        </div>
                        <div class="token-body">
                            <div class="token-detail">
                                <span class="detail-label">Crop ID</span>
                                <span class="detail-value">${token.linked_crop_id}</span>
                            </div>
                            <div class="token-detail">
                                <span class="detail-label">Owner</span>
                                <span class="detail-value">${token.owner_id}</span>
                            </div>
                            <div class="token-detail">
                                <span class="detail-label">Created</span>
                                <span class="detail-value">${new Date(token.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                        ${token.status === 'CREATED' ? `
                            <button class="btn-secondary btn-block" onclick="listToken('${token.token_id}', '${token.owner_id}')">
                                List for Sale
                            </button>
                        ` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading tokens:', error);
            }
        }

        // List token
        async function listToken(tokenId, sellerId) {
            try {
                const response = await fetch(`${API_BASE}/tokens/list`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({token_id: tokenId, seller_id: sellerId})
                });

                const data = await response.json();
                if (data.success) {
                    showNotification('Token listed successfully!', 'success');
                    loadTokens();
                    loadStats();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                showNotification('Error listing token', 'error');
            }
        }

        // Settlement
        document.getElementById('settlementForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                token_id: document.getElementById('settleTokenId').value,
                buyer_id: document.getElementById('buyerId').value
            };

            try {
                const response = await fetch(`${API_BASE}/settlements/execute`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                const resultDiv = document.getElementById('settlementResult');
                
                if (data.success) {
                    resultDiv.className = 'result-message success';
                    resultDiv.innerHTML = `
                        <div class="success-icon">‚ö°</div>
                        <h3>Settlement Executed Successfully!</h3>
                        <div class="result-details">
                            <p><strong>Settlement ID:</strong> ${data.settlement.settlement_id}</p>
                            <p><strong>Amount:</strong> ‚Çπ${data.settlement.total_amount.toFixed(2)}</p>
                            <p><strong>Time:</strong> ${data.settlement_time_seconds}s</p>
                        </div>
                    `;
                    document.getElementById('settlementForm').reset();
                    loadStats();
                    loadTokens();
                    loadSettlements();
                    loadAuditTrail();
                } else {
                    resultDiv.className = 'result-message error';
                    resultDiv.innerHTML = `<div class="error-icon">‚úó</div><p>${data.message}</p>`;
                }
            } catch (error) {
                document.getElementById('settlementResult').className = 'result-message error';
                document.getElementById('settlementResult').innerHTML = `<div class="error-icon">‚úó</div><p>Error: ${error.message}</p>`;
            }
        });

        // Load settlements
        async function loadSettlements() {
            try {
                const response = await fetch(`${API_BASE}/settlements`);
                const data = await response.json();
                
                const list = document.getElementById('settlementsList');
                if (data.settlements.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>No settlements yet</p></div>';
                    return;
                }

                list.innerHTML = data.settlements.map(s => `
                    <div class="settlement-card">
                        <div class="settlement-header">
                            <span class="settlement-id">${s.settlement_id}</span>
                            <span class="badge badge-completed">${s.settlement_status}</span>
                        </div>
                        <div class="settlement-flow">
                            <span class="party">${s.seller_id}</span>
                            <span class="arrow">‚Üí</span>
                            <span class="party">${s.buyer_id}</span>
                        </div>
                        <div class="settlement-amount">‚Çπ${s.total_amount.toFixed(2)}</div>
                        <div class="settlement-meta">${s.quantity}kg @ ‚Çπ${s.price_per_kg}/kg</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading settlements:', error);
            }
        }

        // Load audit trail
        async function loadAuditTrail() {
            try {
                const response = await fetch(`${API_BASE}/audit/trail`);
                const data = await response.json();
                
                const trail = document.getElementById('auditTrail');
                if (data.audit_trail.length === 0) {
                    trail.innerHTML = '<div class="empty-state"><p>No audit events yet</p></div>';
                    return;
                }

                trail.innerHTML = data.audit_trail.map((entry, idx) => `
                    <div class="audit-block">
                        <div class="block-number">Block #${idx + 1}</div>
                        <div class="block-content">
                            <div class="block-header">
                                <span class="event-type">${entry.event_type}</span>
                                <span class="event-time">${new Date(entry.timestamp).toLocaleString()}</span>
                            </div>
                            <div class="block-actor">Actor: ${entry.actor}</div>
                            <div class="block-data">${JSON.stringify(entry.data)}</div>
                            <div class="block-hash">
                                <span class="hash-label">Hash:</span>
                                <span class="hash-value">${entry.current_hash.substring(0, 32)}...</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading audit trail:', error);
            }
        }

        // Verify integrity
        async function verifyAuditIntegrity() {
            try {
                const response = await fetch(`${API_BASE}/audit/verify`);
                const data = await response.json();
                
                const resultDiv = document.getElementById('verificationResult');
                if (data.valid) {
                    resultDiv.className = 'verification-result success';
                    resultDiv.innerHTML = `<div class="success-icon">‚úì</div><p>${data.message} - ${data.total_entries} entries verified</p>`;
                } else {
                    resultDiv.className = 'verification-result error';
                    resultDiv.innerHTML = `<div class="error-icon">‚úó</div><p>${data.message}</p>`;
                }
            } catch (error) {
                console.error('Error verifying integrity:', error);
            }
        }

        // Notification helper
        function showNotification(message, type) {
            alert(message);
        }

        // Filter tokens
        document.getElementById('statusFilter')?.addEventListener('change', loadTokens);
    </script>
</body>
</html>